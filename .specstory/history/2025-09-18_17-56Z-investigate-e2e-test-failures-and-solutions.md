<!-- Generated by SpecStory -->

# Investigate e2e test failures and solutions (2025-09-18 17:56Z)

_**User (2025-09-18 18:10Z)**_

I tried running the @e2e-tests and the pasted output happened. Can you please understand why did these tests fail, then output a plan to fix it?


<PASTED INPUT>
> loan-system-e2e@0.1.0 e2e:up /Users/tazabreu/@Projects/scratchpad/loan-service-genai-labs/e2e-tests
> docker compose -f ../docker/docker-compose.yml up --build -d

[+] Building 20.4s (33/33) FINISHED                                                                                                                                                     docker:desktop-linux
 => [loan-api internal] load build definition from Dockerfile                                                                                                                                           0.0s
 => => transferring dockerfile: 1.03kB                                                                                                                                                                  0.0s
 => [loan-notification-service internal] load build definition from Dockerfile                                                                                                                          0.0s
 => => transferring dockerfile: 1.01kB                                                                                                                                                                  0.0s
 => [loan-api internal] load metadata for docker.io/library/eclipse-temurin:21-jre                                                                                                                      1.7s
 => [loan-notification-service internal] load metadata for docker.io/library/maven:3.9-eclipse-temurin-21                                                                                               1.9s
 => [loan-notification-service internal] load .dockerignore                                                                                                                                             0.0s
 => => transferring context: 2B                                                                                                                                                                         0.0s
 => [loan-api internal] load .dockerignore                                                                                                                                                              0.0s
 => => transferring context: 2B                                                                                                                                                                         0.0s
 => [loan-api build 1/9] FROM docker.io/library/maven:3.9-eclipse-temurin-21@sha256:674ec814977fd05dc5cd3627802efb756351f27d4f029bc47b8a7b5156bb9231                                                    0.0s
 => [loan-api stage-1 1/3] FROM docker.io/library/eclipse-temurin:21-jre@sha256:9dc74491b9c961b24cd16939b26c4dc82259df7f55677b232392d85eef7f6ed0                                                        0.0s
 => [loan-notification-service stage-1 2/3] ADD https://github.com/open-telemetry/opentelemetry-java-instrumentation/releases/download/v2.7.0/opentelemetry-javaagent.jar /otel/opentelemetry-javaagen  0.6s
 => [loan-notification-service internal] load build context                                                                                                                                             3.7s
 => => transferring context: 3.19MB                                                                                                                                                                     3.6s
 => [loan-api internal] load build context                                                                                                                                                              3.7s
 => => transferring context: 3.19MB                                                                                                                                                                     3.6s
 => CACHED [loan-notification-service build 2/9] WORKDIR /workspace                                                                                                                                     0.0s
 => CACHED [loan-api build 3/9] COPY pom.xml ./                                                                                                                                                         0.0s
 => CACHED [loan-api build 4/9] COPY loan-api/pom.xml loan-api/pom.xml                                                                                                                                  0.0s
 => CACHED [loan-api build 5/9] COPY loan-events/pom.xml loan-events/pom.xml                                                                                                                            0.0s
 => CACHED [loan-api build 6/9] COPY loan-notification-service/pom.xml loan-notification-service/pom.xml                                                                                                0.0s
 => CACHED [loan-notification-service build 7/9] RUN mvn -q -DskipTests dependency:go-offline                                                                                                           0.0s
 => [loan-notification-service build 8/9] COPY . .                                                                                                                                                      1.5s
 => [loan-api build 9/9] RUN mvn -q -DskipTests -pl loan-api -am package                                                                                                                               12.6s
 => CACHED [loan-notification-service build 3/9] COPY pom.xml ./                                                                                                                                        0.0s
 => CACHED [loan-notification-service build 4/9] COPY loan-api/pom.xml loan-api/pom.xml                                                                                                                 0.0s
 => CACHED [loan-notification-service build 5/9] COPY loan-events/pom.xml loan-events/pom.xml                                                                                                           0.0s
 => CACHED [loan-notification-service build 6/9] COPY loan-notification-service/pom.xml loan-notification-service/pom.xml                                                                               0.0s
 => CACHED [loan-notification-service build 7/9] RUN mvn -q -DskipTests dependency:go-offline                                                                                                           0.0s
 => CACHED [loan-notification-service build 8/9] COPY . .                                                                                                                                               0.0s
 => [loan-notification-service build 9/9] RUN mvn -q -DskipTests -pl loan-notification-service -am package                                                                                              7.0s
 => CACHED [loan-api stage-1 2/3] ADD https://github.com/open-telemetry/opentelemetry-java-instrumentation/releases/download/v2.7.0/opentelemetry-javaagent.jar /otel/opentelemetry-javaagent.jar       0.0s
 => [loan-notification-service stage-1 3/3] COPY --from=build /workspace/loan-notification-service/target/*-exec.jar /app/app.jar                                                                       0.1s
 => [loan-notification-service] exporting to image                                                                                                                                                      0.1s
 => => exporting layers                                                                                                                                                                                 0.1s
 => => writing image sha256:8e7da1e32807ee288efbd23c6ec5736fd4371968fd1bf30b0c50a9912faa5b78                                                                                                            0.0s
 => => naming to docker.io/library/docker-loan-notification-service                                                                                                                                     0.0s
 => [loan-notification-service] resolving provenance for metadata file                                                                                                                                  0.0s
 => [loan-api stage-1 3/3] COPY --from=build /workspace/loan-api/target/*-exec.jar /app/app.jar                                                                                                         0.1s
 => [loan-api] exporting to image                                                                                                                                                                       0.2s
 => => exporting layers                                                                                                                                                                                 0.2s
 => => writing image sha256:1ac7ae4237dae3da95b76135b65cdf2d122f26bb53fa872dbb84ec6be3662326                                                                                                            0.0s
 => => naming to docker.io/library/docker-loan-api                                                                                                                                                      0.0s
 => [loan-api] resolving provenance for metadata file                                                                                                                                                   0.0s
[+] Running 2/2
 ✔ loan-api                   Built                                                                                                                                                                     0.0s 
[+] Running 13/13ion-service  Built                                                                                                                                                                     0.0s 
 ✔ loan-api                                      Built                                                                                                                                                  0.0s  ✔ loan-notification-service                     Built                                                                                                                                                  0.0s 
 ✔ Container docker-alloy-1                      Started                                                                                                                                               13.6s 
 ✔ Container docker-tempo-1                      Started                                                                                                                                               13.6s 
 ✔ Container docker-grafana-1                    Running                                                                                                                                                0.0s 
 ✔ Container docker-prometheus-1                 Running                                                                                                                                                0.0s 
 ✔ Container docker-promtail-1                   Running                                                                                                                                                0.0s 
 ✔ Container docker-redpanda-1                   Running                                                                                                                                                0.0s 
 ✔ Container docker-loki-1                       Running                                                                                                                                                0.0s 
 ✔ Container docker-flagd-1                      Started                                                                                                                                               13.6s 
 ✔ Container docker-postgres-1                   Running                                                                                                                                                0.0s 
 ✔ Container docker-loan-notification-service-1  Started                                                                                                                                               13.6s 
 ✔ Container docker-loan-api-1                   Started                                                                                                                                               13.9s 

> loan-system-e2e@0.1.0 e2e:wait /Users/tazabreu/@Projects/scratchpad/loan-service-genai-labs/e2e-tests
> wait-on -t 120000 http://localhost:8081/actuator/health tcp:localhost:5432 tcp:localhost:9092 tcp:localhost:19092


> loan-system-e2e@0.1.0 test /Users/tazabreu/@Projects/scratchpad/loan-service-genai-labs/e2e-tests
> jest --runInBand --config ./jest.config.ts

  console.info
    {"level":"INFO","timestamp":"2025-09-18T23:38:34.868Z","logger":"kafkajs","message":"[Consumer] Starting","groupId":"e2e-probe-9a19cbfb-0627-428b-875c-d9d878cc2703"}

      at node_modules/.pnpm/kafkajs@2.2.4/node_modules/kafkajs/src/loggers/console.js:13:22

  console.info
    {"level":"INFO","timestamp":"2025-09-18T23:38:34.908Z","logger":"kafkajs","message":"[ConsumerGroup] Consumer has joined the group","groupId":"e2e-probe-9a19cbfb-0627-428b-875c-d9d878cc2703","memberId":"kafkajs-8a6517db-11f4-4b07-95db-21373baa6c03","leaderId":"kafkajs-8a6517db-11f4-4b07-95db-21373baa6c03","isLeader":true,"memberAssignment":{"loan-events":[0]},"groupProtocol":"RoundRobinAssigner","duration":20}

      at node_modules/.pnpm/kafkajs@2.2.4/node_modules/kafkajs/src/loggers/console.js:13:22

  console.info
    {"level":"INFO","timestamp":"2025-09-18T23:38:40.634Z","logger":"kafkajs","message":"[Runner] consumer not running, exiting","groupId":"e2e-probe-9a19cbfb-0627-428b-875c-d9d878cc2703","memberId":"kafkajs-8a6517db-11f4-4b07-95db-21373baa6c03"}

      at node_modules/.pnpm/kafkajs@2.2.4/node_modules/kafkajs/src/loggers/console.js:13:22

  console.info
    {"level":"INFO","timestamp":"2025-09-18T23:38:40.646Z","logger":"kafkajs","message":"[Consumer] Stopped","groupId":"e2e-probe-9a19cbfb-0627-428b-875c-d9d878cc2703"}

      at node_modules/.pnpm/kafkajs@2.2.4/node_modules/kafkajs/src/loggers/console.js:13:22

  console.info
    {"level":"INFO","timestamp":"2025-09-18T23:38:40.647Z","logger":"kafkajs","message":"[Consumer] Stopped","groupId":"e2e-probe-9a19cbfb-0627-428b-875c-d9d878cc2703"}

      at node_modules/.pnpm/kafkajs@2.2.4/node_modules/kafkajs/src/loggers/console.js:13:22

  console.info
    {"level":"INFO","timestamp":"2025-09-18T23:38:40.680Z","logger":"kafkajs","message":"[Consumer] Starting","groupId":"e2e-probe-f6c384d4-a6e4-4ba9-8c31-095a45874a83"}

      at node_modules/.pnpm/kafkajs@2.2.4/node_modules/kafkajs/src/loggers/console.js:13:22

  console.info
    {"level":"INFO","timestamp":"2025-09-18T23:38:40.685Z","logger":"kafkajs","message":"[ConsumerGroup] Consumer has joined the group","groupId":"e2e-probe-f6c384d4-a6e4-4ba9-8c31-095a45874a83","memberId":"kafkajs-89e0c43c-5f6a-4ef5-a369-1dbf0d255c49","leaderId":"kafkajs-89e0c43c-5f6a-4ef5-a369-1dbf0d255c49","isLeader":true,"memberAssignment":{"loan-events":[0]},"groupProtocol":"RoundRobinAssigner","duration":4}

      at node_modules/.pnpm/kafkajs@2.2.4/node_modules/kafkajs/src/loggers/console.js:13:22

  console.info
    {"level":"INFO","timestamp":"2025-09-18T23:38:46.703Z","logger":"kafkajs","message":"[Runner] consumer not running, exiting","groupId":"e2e-probe-f6c384d4-a6e4-4ba9-8c31-095a45874a83","memberId":"kafkajs-89e0c43c-5f6a-4ef5-a369-1dbf0d255c49"}

      at node_modules/.pnpm/kafkajs@2.2.4/node_modules/kafkajs/src/loggers/console.js:13:22

  console.info
    {"level":"INFO","timestamp":"2025-09-18T23:38:46.706Z","logger":"kafkajs","message":"[Consumer] Stopped","groupId":"e2e-probe-f6c384d4-a6e4-4ba9-8c31-095a45874a83"}

      at node_modules/.pnpm/kafkajs@2.2.4/node_modules/kafkajs/src/loggers/console.js:13:22

  console.info
    {"level":"INFO","timestamp":"2025-09-18T23:38:46.709Z","logger":"kafkajs","message":"[Consumer] Stopped","groupId":"e2e-probe-f6c384d4-a6e4-4ba9-8c31-095a45874a83"}

      at node_modules/.pnpm/kafkajs@2.2.4/node_modules/kafkajs/src/loggers/console.js:13:22

 FAIL  src/tests/manual_rejection_and_idempotency.e2e.spec.ts (13.317 s)
  Epic: Manual rejection & idempotency safeguards
    ✕ Given pending approval, When rejected, Then status/events/logs reflect rejection and approval is blocked (6126 ms)
    ✓ Duplicate contract command returns conflict and does not re-emit events (6061 ms)

  ● Epic: Manual rejection & idempotency safeguards › Given pending approval, When rejected, Then status/events/logs reflect rejection and approval is blocked

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

      20 |
      21 |       const logs = await getServiceLogs('loan-notification-service', { since: '5m' });
    > 22 |       expect(logsContainLoanEvent(logs, id, 'rejectedAt')).toBe(true);
         |                                                            ^
      23 |
      24 |       const approveAfter = await loanClient.approve(id, { 'X-User': 'e2e-approver' });
      25 |       expect(approveAfter.status).toBe(409);

      at Object.<anonymous> (src/tests/manual_rejection_and_idempotency.e2e.spec.ts:22:60)

  console.info
    {"level":"INFO","timestamp":"2025-09-18T23:38:46.952Z","logger":"kafkajs","message":"[Consumer] Starting","groupId":"e2e-probe-8bffcab2-5695-4c20-8148-a434d2147be8"}

      at node_modules/.pnpm/kafkajs@2.2.4/node_modules/kafkajs/src/loggers/console.js:13:22

  console.info
    {"level":"INFO","timestamp":"2025-09-18T23:38:46.968Z","logger":"kafkajs","message":"[ConsumerGroup] Consumer has joined the group","groupId":"e2e-probe-8bffcab2-5695-4c20-8148-a434d2147be8","memberId":"kafkajs-28a83632-aa20-4eb3-9c02-8e02e1dc28f9","leaderId":"kafkajs-28a83632-aa20-4eb3-9c02-8e02e1dc28f9","isLeader":true,"memberAssignment":{"loan-events":[0]},"groupProtocol":"RoundRobinAssigner","duration":12}

      at node_modules/.pnpm/kafkajs@2.2.4/node_modules/kafkajs/src/loggers/console.js:13:22

  console.info
    {"level":"INFO","timestamp":"2025-09-18T23:38:54.803Z","logger":"kafkajs","message":"[Runner] consumer not running, exiting","groupId":"e2e-probe-8bffcab2-5695-4c20-8148-a434d2147be8","memberId":"kafkajs-28a83632-aa20-4eb3-9c02-8e02e1dc28f9"}

      at node_modules/.pnpm/kafkajs@2.2.4/node_modules/kafkajs/src/loggers/console.js:13:22

  console.info
    {"level":"INFO","timestamp":"2025-09-18T23:38:54.806Z","logger":"kafkajs","message":"[Consumer] Stopped","groupId":"e2e-probe-8bffcab2-5695-4c20-8148-a434d2147be8"}

      at node_modules/.pnpm/kafkajs@2.2.4/node_modules/kafkajs/src/loggers/console.js:13:22

  console.info
    {"level":"INFO","timestamp":"2025-09-18T23:38:54.807Z","logger":"kafkajs","message":"[Consumer] Stopped","groupId":"e2e-probe-8bffcab2-5695-4c20-8148-a434d2147be8"}

      at node_modules/.pnpm/kafkajs@2.2.4/node_modules/kafkajs/src/loggers/console.js:13:22

 FAIL  src/tests/contract_disburse_pay.e2e.spec.ts (8.09 s)
  Epic: Contract → Disburse → Pay
    ✕ Given an APPROVED loan, When contract → disburse → pay (liquidação completa), Then DB/Kafka/logs align (7869 ms)

  ● Epic: Contract → Disburse → Pay › Given an APPROVED loan, When contract → disburse → pay (liquidação completa), Then DB/Kafka/logs align

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

      64 |         logsContainLoanEvent(logs, id, 'disbursedAt') ||
      65 |         logsContainLoanEvent(logs, id, 'paidAt')
    > 66 |       ).toBe(true);
         |         ^
      67 |     } finally {
      68 |       await probe.stop();
      69 |     }

      at Object.<anonymous> (src/tests/contract_disburse_pay.e2e.spec.ts:66:9)

  console.info
    {"level":"INFO","timestamp":"2025-09-18T23:38:55.007Z","logger":"kafkajs","message":"[Consumer] Starting","groupId":"e2e-probe-e9605370-1faf-41b3-a39a-bfba7b1b2e52"}

      at node_modules/.pnpm/kafkajs@2.2.4/node_modules/kafkajs/src/loggers/console.js:13:22

  console.info
    {"level":"INFO","timestamp":"2025-09-18T23:38:55.025Z","logger":"kafkajs","message":"[ConsumerGroup] Consumer has joined the group","groupId":"e2e-probe-e9605370-1faf-41b3-a39a-bfba7b1b2e52","memberId":"kafkajs-9caf2c31-161e-46dd-9d5e-6cb5248c3101","leaderId":"kafkajs-9caf2c31-161e-46dd-9d5e-6cb5248c3101","isLeader":true,"memberAssignment":{"loan-events":[0]},"groupProtocol":"RoundRobinAssigner","duration":12}

      at node_modules/.pnpm/kafkajs@2.2.4/node_modules/kafkajs/src/loggers/console.js:13:22

  console.info
    {"level":"INFO","timestamp":"2025-09-18T23:39:00.855Z","logger":"kafkajs","message":"[Runner] consumer not running, exiting","groupId":"e2e-probe-e9605370-1faf-41b3-a39a-bfba7b1b2e52","memberId":"kafkajs-9caf2c31-161e-46dd-9d5e-6cb5248c3101"}

      at node_modules/.pnpm/kafkajs@2.2.4/node_modules/kafkajs/src/loggers/console.js:13:22

  console.info
    {"level":"INFO","timestamp":"2025-09-18T23:39:00.863Z","logger":"kafkajs","message":"[Consumer] Stopped","groupId":"e2e-probe-e9605370-1faf-41b3-a39a-bfba7b1b2e52"}

      at node_modules/.pnpm/kafkajs@2.2.4/node_modules/kafkajs/src/loggers/console.js:13:22

  console.info
    {"level":"INFO","timestamp":"2025-09-18T23:39:00.865Z","logger":"kafkajs","message":"[Consumer] Stopped","groupId":"e2e-probe-e9605370-1faf-41b3-a39a-bfba7b1b2e52"}

      at node_modules/.pnpm/kafkajs@2.2.4/node_modules/kafkajs/src/loggers/console.js:13:22

 FAIL  src/tests/simulate_auto_approval.e2e.spec.ts (6.061 s)
  Epic: Simulate (auto-approval path)
    ✕ Given simulate below threshold, Then loan is APPROVED and events/logs exist (5868 ms)

  ● Epic: Simulate (auto-approval path) › Given simulate below threshold, Then loan is APPROVED and events/logs exist

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

      29 |       const logs = await getServiceLogs('loan-notification-service', { since: '5m' });
      30 |       const ok = logsContainLoanEvent(logs, id, 'simulatedAt') || logsContainLoanEvent(logs, id, 'approvedAt');
    > 31 |       expect(ok).toBe(true);
         |                  ^
      32 |     } finally {
      33 |       await probe.stop();
      34 |     }

      at Object.<anonymous> (src/tests/simulate_auto_approval.e2e.spec.ts:31:18)

  console.info
    {"level":"INFO","timestamp":"2025-09-18T23:39:01.067Z","logger":"kafkajs","message":"[Consumer] Starting","groupId":"e2e-probe-97edaa42-c4a0-4da0-85ba-a4206fc54874"}

      at node_modules/.pnpm/kafkajs@2.2.4/node_modules/kafkajs/src/loggers/console.js:13:22

  console.info
    {"level":"INFO","timestamp":"2025-09-18T23:39:01.084Z","logger":"kafkajs","message":"[ConsumerGroup] Consumer has joined the group","groupId":"e2e-probe-97edaa42-c4a0-4da0-85ba-a4206fc54874","memberId":"kafkajs-f0a55aca-a6a0-496f-9c07-25be69ac2e4f","leaderId":"kafkajs-f0a55aca-a6a0-496f-9c07-25be69ac2e4f","isLeader":true,"memberAssignment":{"loan-events":[0]},"groupProtocol":"RoundRobinAssigner","duration":12}

      at node_modules/.pnpm/kafkajs@2.2.4/node_modules/kafkajs/src/loggers/console.js:13:22

  console.info
    {"level":"INFO","timestamp":"2025-09-18T23:39:07.914Z","logger":"kafkajs","message":"[Runner] consumer not running, exiting","groupId":"e2e-probe-97edaa42-c4a0-4da0-85ba-a4206fc54874","memberId":"kafkajs-f0a55aca-a6a0-496f-9c07-25be69ac2e4f"}

      at node_modules/.pnpm/kafkajs@2.2.4/node_modules/kafkajs/src/loggers/console.js:13:22

  console.info
    {"level":"INFO","timestamp":"2025-09-18T23:39:07.919Z","logger":"kafkajs","message":"[Consumer] Stopped","groupId":"e2e-probe-97edaa42-c4a0-4da0-85ba-a4206fc54874"}

      at node_modules/.pnpm/kafkajs@2.2.4/node_modules/kafkajs/src/loggers/console.js:13:22

  console.info
    {"level":"INFO","timestamp":"2025-09-18T23:39:07.920Z","logger":"kafkajs","message":"[Consumer] Stopped","groupId":"e2e-probe-97edaa42-c4a0-4da0-85ba-a4206fc54874"}

      at node_modules/.pnpm/kafkajs@2.2.4/node_modules/kafkajs/src/loggers/console.js:13:22

 PASS  src/tests/manual_approval_flow.e2e.spec.ts (7.039 s)
  Epic: Manual approval flow (Flagd enabled, amount > threshold)
    ✓ Given simulate above threshold, Then loan is PENDING_APPROVAL, When approve → Then APPROVED with events/logs (6863 ms)

  console.info
    {"level":"INFO","timestamp":"2025-09-18T23:39:08.139Z","logger":"kafkajs","message":"[Consumer] Starting","groupId":"e2e-probe-2348eac2-51ac-4fa3-b846-b18e284d512d"}

      at node_modules/.pnpm/kafkajs@2.2.4/node_modules/kafkajs/src/loggers/console.js:13:22

  console.info
    {"level":"INFO","timestamp":"2025-09-18T23:39:08.149Z","logger":"kafkajs","message":"[ConsumerGroup] Consumer has joined the group","groupId":"e2e-probe-2348eac2-51ac-4fa3-b846-b18e284d512d","memberId":"kafkajs-b7f79d07-1086-431a-ad54-add049b1f56f","leaderId":"kafkajs-b7f79d07-1086-431a-ad54-add049b1f56f","isLeader":true,"memberAssignment":{"loan-events":[0]},"groupProtocol":"RoundRobinAssigner","duration":8}

      at node_modules/.pnpm/kafkajs@2.2.4/node_modules/kafkajs/src/loggers/console.js:13:22

  console.info
    {"level":"INFO","timestamp":"2025-09-18T23:39:14.014Z","logger":"kafkajs","message":"[Runner] consumer not running, exiting","groupId":"e2e-probe-2348eac2-51ac-4fa3-b846-b18e284d512d","memberId":"kafkajs-b7f79d07-1086-431a-ad54-add049b1f56f"}

      at node_modules/.pnpm/kafkajs@2.2.4/node_modules/kafkajs/src/loggers/console.js:13:22

  console.info
    {"level":"INFO","timestamp":"2025-09-18T23:39:14.050Z","logger":"kafkajs","message":"[Consumer] Stopped","groupId":"e2e-probe-2348eac2-51ac-4fa3-b846-b18e284d512d"}

      at node_modules/.pnpm/kafkajs@2.2.4/node_modules/kafkajs/src/loggers/console.js:13:22

  console.info
    {"level":"INFO","timestamp":"2025-09-18T23:39:14.051Z","logger":"kafkajs","message":"[Consumer] Stopped","groupId":"e2e-probe-2348eac2-51ac-4fa3-b846-b18e284d512d"}

      at node_modules/.pnpm/kafkajs@2.2.4/node_modules/kafkajs/src/loggers/console.js:13:22

  console.info
    {"level":"INFO","timestamp":"2025-09-18T23:39:14.102Z","logger":"kafkajs","message":"[Consumer] Starting","groupId":"e2e-probe-fd0213f0-749b-4b31-8625-3c5f0b8e85e4"}

      at node_modules/.pnpm/kafkajs@2.2.4/node_modules/kafkajs/src/loggers/console.js:13:22

  console.info
    {"level":"INFO","timestamp":"2025-09-18T23:39:14.107Z","logger":"kafkajs","message":"[ConsumerGroup] Consumer has joined the group","groupId":"e2e-probe-fd0213f0-749b-4b31-8625-3c5f0b8e85e4","memberId":"kafkajs-60c3c24c-10bf-4254-9e6c-2bd53f957690","leaderId":"kafkajs-60c3c24c-10bf-4254-9e6c-2bd53f957690","isLeader":true,"memberAssignment":{"loan-events":[0]},"groupProtocol":"RoundRobinAssigner","duration":4}

      at node_modules/.pnpm/kafkajs@2.2.4/node_modules/kafkajs/src/loggers/console.js:13:22

  console.info
    {"level":"INFO","timestamp":"2025-09-18T23:39:20.067Z","logger":"kafkajs","message":"[Runner] consumer not running, exiting","groupId":"e2e-probe-fd0213f0-749b-4b31-8625-3c5f0b8e85e4","memberId":"kafkajs-60c3c24c-10bf-4254-9e6c-2bd53f957690"}

      at node_modules/.pnpm/kafkajs@2.2.4/node_modules/kafkajs/src/loggers/console.js:13:22

  console.info
    {"level":"INFO","timestamp":"2025-09-18T23:39:20.071Z","logger":"kafkajs","message":"[Consumer] Stopped","groupId":"e2e-probe-fd0213f0-749b-4b31-8625-3c5f0b8e85e4"}

      at node_modules/.pnpm/kafkajs@2.2.4/node_modules/kafkajs/src/loggers/console.js:13:22

  console.info
    {"level":"INFO","timestamp":"2025-09-18T23:39:20.072Z","logger":"kafkajs","message":"[Consumer] Stopped","groupId":"e2e-probe-fd0213f0-749b-4b31-8625-3c5f0b8e85e4"}

      at node_modules/.pnpm/kafkajs@2.2.4/node_modules/kafkajs/src/loggers/console.js:13:22

 PASS  src/tests/partial_payments.e2e.spec.ts (12.149 s)
  Epic: Partial repayments and overpayment guardrails
    ✓ Partial repayment reduces remaining balance while staying DISBURSED and emits payment event (5963 ms)
    ✓ Overpayment request is rejected with 400 and leaves balance untouched (6022 ms)

 PASS  src/tests/observability.e2e.spec.ts
  Epic: Observability and Readiness
    ✓ Health endpoint is UP (15 ms)
    ✓ Metrics endpoint exposes loan metrics (40 ms)
    ✓ Notification service logs include structured loan_event entries after lifecycle activity (3469 ms)

 PASS  src/tests/negative_paths.e2e.spec.ts
  Epic: Negative paths and validation
    ✓ Rejects disburse before contract with 409 (32 ms)
    ✓ Rejects negative payment with 400 (39 ms)

Test Suites: 3 failed, 4 passed, 7 total
Tests:       3 failed, 9 passed, 12 total

<PASTED INPUT/>

---

_**Assistant**_

<think><details><summary>Thought Process</summary>Let me analyze the test failure output to understand what's happening:

1. The Docker services are starting successfully - containers are built and running.
2. The wait-on command for health endpoints and services is completing successfully.
3. But several tests are failing because they expect certain log events to be present, but they're not finding them.

The failing tests are:
1. `manual_rejection_and_idempotency.e2e.spec.ts` - expects 'rejectedAt' event in logs but doesn't find it
2. `contract_disburse_pay.e2e.spec.ts` - expects 'disbursedAt' or 'paidAt' events in logs but doesn't find them  
3. `simulate_auto_approval.e2e.spec.ts` - expects 'simulatedAt' or 'approvedAt' events in logs but doesn't find them

The pattern is clear: the tests are looking for specific loan events in the notification service logs using `logsContainLoanEvent()` function, but these events aren't being found.

This suggests either:
1. The loan-notification-service isn't receiving/processing the events from Kafka
2. The loan-notification-service isn't logging the events in the expected format
3. The log parsing logic in the tests is incorrect</details></think>

---

